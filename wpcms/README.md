# wpcms — Production セキュリティ＆運用メモ

- **HTTPS**: 本番は必ず `https` を使用する。JWT や認証情報、アップロードされたファイルの送受信は TLS を前提にする。

- **JWT シークレット管理**:
  - `JWT_AUTH_SECRET_KEY` は `wp-config.php` に直書きする場合でも安全な長くランダムな文字列にする。
  - 可能であれば環境変数やホストのシークレット管理機能（例：ホスティングの Secret Manager）を使い、コードリポジトリに平文で置かない。

- **CORS 制限**:
  - 開発時は `Access-Control-Allow-Origin: http://localhost:5173` のように限定するが、本番ではフロントドメインのみを許可する。
  - ワイルドカード `*` は使用しない。必要に応じて認証済みユーザーのみ許可する設定にする。

- **ACF / REST 公開制御**:
  - ACF フィールドを REST に公開する場合は、必要最小限に留める。
  - 敏感なフィールドは公開しないか、`register_rest_field` や `permission_callback` で認証済みユーザーのみアクセスできるようにする。
  - プラグイン「ACF to REST API」を使う場合は、公開範囲を確認して不要なフィールド公開をオフにする。

- **ファイルアップロード**:
  - MIME タイプチェック、拡張子チェック、ファイルサイズ上限をサーバー側でも必ず実施する。
  - 可能であればアップロード直後にウイルススキャンや画像の再エンコードを行う。
  - アップロード先のパス名は推測できないものにし、直接の実行権限がないディレクトリを使う。

- **認証トークンの扱い（フロントエンド）**:
  - 公開クライアントでは `localStorage` にトークンを置くと XSS により盗まれるリスクがある。可能であれば `httpOnly` クッキーを用いたセッションや短寿命のトークン＋リフレッシュの設計を検討する。
  - JavaScript で扱う場合は最小権限、短い有効期限、トークンの定期ローテーションを行う。

- **ログとデバッグ**:
  - 本番で `WP_DEBUG` は `false` にする。エラーログは安全な場所に集約し、機密情報が出力されないようにする。

- **レート制限 / ブルートフォース対策**:
  - JWT トークンエンドポイントや投稿 API にはレート制限を設ける。ログイン試行や大量の POST を検出して防御する。

- **権限チェック**:
  - REST 経由で投稿やメディアを作る API は、ユーザー権限（`current_user_can('edit_posts')` など）を厳密に確認すること。
  - 公開 API を作る場合は CSRF / 権限制御を厳格に。

- **運用（アップデート）**:
  - WordPress本体、テーマ、プラグインは定期的に更新する。互換性テストを行ったうえでロールアウトする。